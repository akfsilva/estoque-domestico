<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vault-Tec: Estoque Doméstico</title>

<link rel="manifest" href="./manifest.json">
<link rel="icon" href="./icon-192.png">

<style>
:root{
  --bg:#0b1a12;
  --panel:#102a1c;
  --text:#c9ffd0;
  --accent:#4cff4c;
  --warn:#ffcc00;
  --danger:#ff5555;
  --border:#2cff6a;
}

*{box-sizing:border-box;font-family:"Courier New",monospace}

body{margin:0;background:var(--bg);color:var(--text); image-rendering: pixelated; padding-bottom: 50px;}

header{
  display:flex;
  align-items:center;
  gap:12px;
  padding:14px;
  border-bottom:2px solid var(--border);
  box-shadow: 0 0 10px var(--panel);
}

header img{ width:40px; height:40px; border: 1px solid var(--border); }

h1{margin:0;font-size:1.2rem; text-transform: uppercase; letter-spacing: 2px;}

main{padding:16px}

section {
  background:var(--panel);
  border:2px solid var(--border);
  padding:12px;
  margin-bottom:16px;
  box-shadow: inset 0 0 10px rgba(0,255,0,0.1);
}

h2{margin:0 0 8px 0;font-size:1rem; text-transform: uppercase; color: var(--accent)}

input,button{
  background:black;
  color:var(--text);
  border:1px solid var(--border);
  padding:8px;
  margin:4px 0;
  outline: none;
}

button{cursor:pointer; text-transform: uppercase; font-weight: bold;}
button:active { background: var(--border); color: black; }
button.danger{color:var(--danger); border-color:var(--danger); margin-top: 8px; font-size: 0.7rem; width: 100%;}
.btn-backup { font-size: 0.7rem; width: 48%; }

.category{ border:1px solid var(--border); margin-bottom:10px; background: rgba(0,0,0,0.2); }

.cat-header{
  padding:10px;
  cursor:pointer;
  background:#07160e;
  font-weight:bold;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
}

.cat-body{padding:8px; display:none}

.item{ border-bottom: 1px solid rgba(44, 255, 106, 0.2); padding:12px 0; }
.item:last-child{border-bottom:none}

.item-info { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem; }

.controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.controls label { font-size: 0.6rem; display: block; color: var(--accent); }

.progress{ background:rgba(0,0,0,0.5); border:1px solid var(--border); height:14px; margin: 10px 0; }
.bar{height:100%; background:var(--accent); transition: width 0.3s ease; box-shadow: 0 0 8px var(--accent);}
.low .bar{background:var(--danger); box-shadow: 0 0 8px var(--danger);}
.mid .bar{background:var(--warn); box-shadow: 0 0 8px var(--warn);}

.alert{font-size:.7rem; color:var(--danger); font-weight: bold; text-align: center; animation: blink 1s infinite;}
@keyframes blink { 50% { opacity: 0; } }

#fileInput { display: none; }
</style>
</head>

<body>

<header>
  <img src="./icon-192.png" alt="VAULT">
  <h1>Vault-Tec Stock</h1>
</header>

<main>

<section>
  <h2>Log novo item</h2>
  <input id="n" placeholder="Nome do Item" style="width: 100%;">
  <input id="c" placeholder="Categoria" style="width: 100%;">
  <div class="controls">
    <div>
      <label>ATUAL</label>
      <input id="q" type="number" placeholder="0" style="width: 100%;">
    </div>
    <div>
      <label>META</label>
      <input id="g" type="number" placeholder="0" style="width: 100%;">
    </div>
  </div>
  <button onclick="add()" style="width: 100%; margin-top: 10px;">Executar Entrada</button>
</section>

<div id="estoque"></div>

<section style="margin-top: 30px; border-color: var(--warn);">
  <h2>Terminal de Dados</h2>
  <div style="display: flex; justify-content: space-between;">
    <button class="btn-backup" onclick="exportData()">Exportar JSON</button>
    <button class="btn-backup" onclick="document.getElementById('fileInput').click()">Importar JSON</button>
  </div>
  <input type="file" id="fileInput" accept=".json" onchange="importData(event)">
</section>

</main>

<script>
const KEY="estoque_domestico_vfinal";

const baseItems=[
  {name:"Arroz",cat:"Alimentos",qty:16,goal:48},
  {name:"Feijão",cat:"Alimentos",qty:4,goal:24},
  {name:"Macarrão parafuso",cat:"Alimentos",qty:2,goal:24},
  {name:"Sal",cat:"Alimentos",qty:1,goal:2},
  {name:"Açúcar cristal",cat:"Alimentos",qty:4.5,goal:12},
  {name:"Óleo de soja",cat:"Alimentos",qty:3,goal:12},
  {name:"Óleo misto",cat:"Alimentos",qty:1,goal:12},
  {name:"Molho de tomate",cat:"Alimentos",qty:3,goal:24},
  {name:"Sardinha",cat:"Alimentos",qty:2,goal:24},
  {name:"Capuccino",cat:"Alimentos",qty:0.2,goal:1},
  {name:"Geleia de framboesa",cat:"Alimentos",qty:1,goal:4},
  {name:"Café descafeinado",cat:"Alimentos",qty:0.25,goal:2},
  {name:"Papel toalha",cat:"Limpeza",qty:1,goal:6},
  {name:"Bucha de cozinha",cat:"Limpeza",qty:8,goal:24},
  {name:"Sabão em barra",cat:"Limpeza",qty:10,goal:24},
  {name:"Sabonete antibacteriano",cat:"Higiene",qty:14,goal:48},
  {name:"Sabonete comum",cat:"Higiene",qty:7,goal:48},
  {name:"Desodorante antibacteriano",cat:"Higiene",qty:1,goal:12},
  {name:"Desodorante comum",cat:"Higiene",qty:1,goal:12},
  {name:"Pasta de dente sensível",cat:"Higiene",qty:2,goal:12},
  {name:"Pasta de dente comum",cat:"Higiene",qty:3,goal:12}
];

let items = JSON.parse(localStorage.getItem(KEY)) || baseItems.map(i => ({...i, id: Date.now() + Math.random()}));

function save(){ localStorage.setItem(KEY, JSON.stringify(items)); }

function add(){
  const nome = document.getElementById('n').value;
  const categoriaInput = document.getElementById('c').value || "Outros";
  const catNormalizada = categoriaInput.trim().toLowerCase();
  
  // CORREÇÃO DE CATEGORIA: Busca existente ignorando case
  const catExistente = items.find(i => i.cat.toLowerCase() === catNormalizada);
  const catFinal = catExistente ? catExistente.cat : categoriaInput;

  if(nome){
    items.push({
      id: Date.now() + Math.random(),
      name: nome,
      cat: catFinal,
      qty: +document.getElementById('q').value || 0,
      goal: +document.getElementById('g').value || 0
    });
    save(); render();
    document.getElementById('n').value = document.getElementById('c').value = "";
  }
}

function del(id){
  if(confirm("Confirmar exclusão?")){
    items = items.filter(i => i.id !== id);
    save(); render();
  }
}

function upd(id, key, val){
  const item = items.find(i => i.id === id);
  if(item) {
    item[key] = parseFloat(val) || 0;
    save(); render(); 
  }
}

function toggle(id){
  const el = document.getElementById(id);
  el.style.display = el.style.display === "block" ? "none" : "block";
}

function exportData() {
    const dataStr = JSON.stringify(items, null, 2);
    const blob = new Blob([dataStr], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `estoque_vault_${new Date().toLocaleDateString()}.json`;
    link.click();
}

function importData(event) {
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const imported = JSON.parse(e.target.result);
            if(confirm("Substituir estoque atual pelos dados do arquivo?")) {
                items = imported;
                save(); render();
            }
        } catch(err) { alert("Arquivo inválido!"); }
    };
    reader.readAsText(event.target.files[0]);
}

function render(){
  const out = document.getElementById("estoque");
  out.innerHTML = "";
  const cats = [...new Set(items.map(i => i.cat))];

  cats.forEach(cat => {
    const cid = "cat_" + cat.replace(/[^a-zA-Z0-9]/g, "");
    const catDiv = document.createElement("div");
    catDiv.className = "category";
    
    const catItems = items.filter(i => i.cat === cat);
    const itemsHtml = catItems.map(i => {
      const p = i.goal ? Math.min(100, (i.qty / i.goal) * 100) : 0;
      const cls = p < 30 ? "low" : p < 60 ? "mid" : "";
      return `
        <div class="item">
          <div class="item-info"><b>> ${i.name}</b><span>${p.toFixed(0)}%</span></div>
          <div class="controls">
            <div><label>QTD</label><input type="number" value="${i.qty}" onchange="upd(${i.id},'qty',this.value)"></div>
            <div><label>META</label><input type="number" value="${i.goal}" onchange="upd(${i.id},'goal',this.value)"></div>
          </div>
          <div class="progress ${cls}"><div class="bar" style="width:${p}%"></div></div>
          ${p < 30 ? '<div class="alert">ALERTA: ESTOQUE BAIXO</div>' : ''}
          <button class="danger" onclick="del(${i.id})">Remover Item</button>
        </div>`;
    }).join("");

    catDiv.innerHTML = `<div class="cat-header" onclick="toggle('${cid}')">${cat.toUpperCase()}</div>
                        <div class="cat-body" id="${cid}">${itemsHtml}</div>`;
    out.appendChild(catDiv);
  });
}

render();
</script>
</body>
</html>
